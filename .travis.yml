sudo: required
dist: trusty
language: python
services:
- docker
- postgresql
addons:
  postgresql: "9.5"

before_script:
- docker build -t $BUILDING .
- psql -U postgres -c 'create database test_idigbio;'
- psql -U postgres -c "DROP SCHEMA public CASCADE;" test_idigbio
script:
- docker run --rm -it --net host $BUILDING
  pytest --pguser=postgres --pgpass="" tests/idb tests/idigbio_workers

after_success:
- docker login --username="$DOCKER_USERNAME" --password="$DOCKER_PASSWORD"
# - |
#   if [ -n "$TRAVIS_TAG" ]; then
#     docker tag $BUILDING $DOCKER_IMAGE:$TRAVIS_TAG;
#     docker push $DOCKER_IMAGE:$TRAVIS_TAG;
#   fi
# - |
#   if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
#     docker tag $BUILDING $DOCKER_IMAGE:$TRAVIS_BRANCH;
#     docker push $DOCKER_IMAGE:$TRAVIS_BRANCH;
#   fi
env:
  global:
  - DOCKER_IMAGE=idigbio/idb-backend
  - BUILDING=$DOCKER_IMAGE:$TRAVIS_COMMIT
